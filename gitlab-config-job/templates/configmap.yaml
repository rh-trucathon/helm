apiVersion: v1
kind: ConfigMap
metadata:
  name: gitlab-config-job-config
  namespace: {{ .Values.namespace }}
data:
  CLUSTER: "{{ .Values.cluster }}"
  GITLAB_NAMESPACE: "{{ .Values.gitlab.namespace }}"
  GITOPS_REPO_URL: "{{ .Values.gitops.repoUrl }}"
  GITOPS_BRANCH: "{{ .Values.gitops.branch }}"

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: gitlab-config-job-playbook
  namespace: {{ .Values.namespace }}
data:
  opencodequest.yaml: |
    opencodequest:
      clusters:
        - name: atlantis
          users: [ "rubeus", "johnwr", "howard" ,
                  "niteow2", "blackp", "moondra" , 
                  "captainam" , "saria" , "humanb" ,
                  "rachel" , "mercury" , "thepun" ,
                  "bishop" , "hogun" , "tempera",
                  "rh1", "rh2", "rh3" ]
        - name: central
          users: [ "redgua", "oracle", "misango" ,
                  "penance", "hesh", "shockwa" ,
                  "blackl" , "adawon" , "wonder" ,
                  "newtsc" , "jonatha" , "ironsp" ,
                  "tigra" , "cloak" , "aquagir" ,
                  "rh1", "rh2", "rh3" ]
        - name: gotham
          users: [ "reedri", "bethany", "babygr" ,
                  "rocket", "jonsno", "lightsp" ,
                  "captain" , "coleyo" , "mariah" ,
                  "niteow" , "morita" , "sprite" ,
                  "reaper" , "shatter" , "acegri" ,
                  "rh1", "rh2", "rh3" ]
        - name: madripoor
          users: [ "masong", "yorick", "sokka" ,
                    "cypher", "lucian", "volstag" ,
                    "hellboy" , "bixcal" , "wonderg" ,
                    "resista" , "sydney" , "cliffju" ,
                    "theque" , "ironfi" , "henryj" ,
                    "rh1", "rh2", "rh3" ]
        - name: metropolis
          users: [ "spider", "valkyri", "ironma" ,
                  "dreamg", "batman", "double" ,
                  "billyl" , "cynthia" , "atom" ,
                  "sonyab" , "coyote" , "jackbr" ,
                  "greatk" , "kelpie" , "renaro" ,
                  "rh1", "rh2", "rh3" ]
        - name: wakanda
          users: [ "harriso", "wildcat", "ericaj" ,
                  "blackw", "spring", "doctor" ,
                  "echo" , "sergean" , "turanga" ,
                  "alinap" , "revali" , "delphyn" ,
                  "alfred" , "fordpi" , "bigbos" ,
                  "rh1", "rh2", "rh3" ]
  playbook.yaml: |
    - name: Configure GitLab
      hosts: localhost
      vars:
        cluster: atlantis  # Default cluster, can be overridden with -e cluster=<name>
        gitlab_namespace: gitlab
        gitlab_api: https://{{ "{{" }} gitlab_hostname {{ "}}" }}/api/v4
        domain_name: "{{ "{{" }} gitlab_hostname | regex_replace('^[^.]+\\.', '') {{ "}}" }}"
        ocp_uid: "{{ "{{" }} domain_name.split('.')[2] {{ "}}" }}"
        gh_source_repo: https://github.com/rh-opencodequest/rhdh-templates
        gl_dest_repo: https://root:{{ "{{" }} root_token {{ "}}" }}@{{ "{{" }} gitlab_hostname {{ "}}" }}/rhdh/opencodequest-templates
        repo_local_path: /tmp/gh

        rhdh_gitops_repo: https://root:{{ "{{" }} root_token {{ "}}" }}@{{ "{{" }} gitlab_hostname {{ "}}" }}/gitops/janus-idp-gitops
        rhdh_gitops_repo_local_path: /tmp/janus-idp-gitops
        rhdh_users_repo: https://root:{{ "{{" }} root_token {{ "}}" }}@{{ "{{" }} gitlab_hostname {{ "}}" }}/rhdh/users
        rhdh_users_repo_local_path: /tmp/rhdh-users

      tasks:
        - name: Get GitLab's Route
          kubernetes.core.k8s_info:
            api_version: route.openshift.io/v1
            kind: Route
            name: gitlab
            namespace: '{{ "{{" }} gitlab_namespace {{ "}}" }}'
          register: gitlab_route
          failed_when: gitlab_route.resources|length == 0
          until: gitlab_route is succeeded
          retries: 60
          delay: 5

        - set_fact:
            gitlab_hostname: '{{ "{{" }} gitlab_route.resources[0].spec.host {{ "}}" }}'

        - name: Retrieve root token
          kubernetes.core.k8s_info:
            api_version: v1
            kind: Secret
            name: root-user-personal-token
            namespace: '{{ "{{" }} gitlab_namespace {{ "}}" }}'
          register: r_root_token
          failed_when: r_root_token.resources[0].data.token | length == 0

        - name: Decode root token
          set_fact:
            root_token: '{{ "{{" }} r_root_token.resources[0].data.token | b64decode {{ "}}" }}'

        - name: Load cluster vars
          include_vars:
            file: "vars/opencodequest.yaml"
            name: cluster_vars

        - name: Extract cluster users
          set_fact:
            cluster_users: '{{ "{{" }} cluster_vars.opencodequest.clusters | selectattr("name", "equalto", cluster) | map(attribute="users") | first {{ "}}" }}'

        - name: Check if GitLab user already exists
          ansible.builtin.uri:
            url: '{{ "{{" }} gitlab_api {{ "}}" }}/users?username={{ "{{" }} item {{ "}}" }}'
            method: GET
            headers:
              PRIVATE-TOKEN: '{{ "{{" }} root_token {{ "}}" }}'
            validate_certs: false
            status_code: 200
          register: r_check_user
          retries: 3
          delay: 2
          until: r_check_user.status == 200
          loop: '{{ "{{" }} cluster_users {{ "}}" }}'
          ignore_errors: true

        - name: Filter users that don't exist
          set_fact:
            users_to_create: >-
              {{ "{{" }}
                users_to_create | default([]) +
                ([item] if (r_check_user.results | selectattr('item', 'equalto', item) | map(attribute='json') | list | first | default([]) | length == 0)
                        else [])
              {{ "}}" }}
          loop: '{{ "{{" }} cluster_users {{ "}}" }}'

        - name: Create GitLab users from cluster vars
          ansible.builtin.uri:
            url: '{{ "{{" }} gitlab_api {{ "}}" }}/users'
            method: POST
            body_format: form-urlencoded
            body:
              admin: false
              email: '{{ "{{" }} item {{ "}}" }}@opentlc.com'
              public_email: '{{ "{{" }} item {{ "}}" }}@opentlc.com'
              skip_confirmation: true
              username: '{{ "{{" }} item {{ "}}" }}'
              password: '{{ "{{" }} item[:3] {{ "}}" }}2025!!'
              name: '{{ "{{" }} item | capitalize {{ "}}" }} GitLab User'
            headers:
              PRIVATE-TOKEN: '{{ "{{" }} root_token {{ "}}" }}'
            validate_certs: false
            status_code: [201, 422]
          register: r_user
          retries: 3
          delay: 2
          until: r_user.status in [201, 422]
          loop: '{{ "{{" }} users_to_create | default([]) {{ "}}" }}'
          ignore_errors: true
          when: users_to_create | default([]) | length > 0

        - name: Get GitLab rhdh group
          ansible.builtin.uri:
            url: '{{ "{{" }} gitlab_api {{ "}}" }}/groups/rhdh'
            method: GET
            headers:
              PRIVATE-TOKEN: '{{ "{{" }} root_token {{ "}}" }}'
            validate_certs: false
            status_code: 200
          register: r_group

        - name: Map cluster name to rhdh_users filename
          set_fact:
            rhdh_users_filename: "{{ "{{" }} cluster {{ "}}" }}.yaml"

        - name: Check if rhdh/users repo exists
          ansible.builtin.uri:
            url: '{{ "{{" }} gitlab_api {{ "}}" }}/projects/rhdh%2Fusers'
            method: GET
            headers:
              PRIVATE-TOKEN: '{{ "{{" }} root_token {{ "}}" }}'
            validate_certs: false
            status_code: [200, 404]
          register: r_check_users_repo

        - name: Create rhdh/users repo if it doesn't exist
          ansible.builtin.uri:
            url: '{{ "{{" }} gitlab_api {{ "}}" }}/projects'
            method: POST
            body_format: form-urlencoded
            body:
              name: users
              namespace_id: '{{ "{{" }} r_group.json.id {{ "}}" }}'
              visibility: public
            headers:
              PRIVATE-TOKEN: '{{ "{{" }} root_token {{ "}}" }}'
            validate_certs: false
            status_code: [201, 400, 422]
          register: r_users_repo
          when: r_check_users_repo.status == 404

        - name: Clone rhdh/users repo
          ansible.builtin.git:
            repo: "{{ "{{" }} rhdh_users_repo {{ "}}" }}"
            dest: "{{ "{{" }} rhdh_users_repo_local_path {{ "}}" }}"
            clone: yes
            update: yes
            force: yes
          ignore_errors: true

        - name: Copy rhdh_users file to repository
          ansible.builtin.copy:
            src: "rhdh_users/{{ "{{" }} rhdh_users_filename {{ "}}" }}"
            dest: "{{ "{{" }} rhdh_users_repo_local_path {{ "}}" }}/{{ "{{" }} rhdh_users_filename {{ "}}" }}"
            remote_src: false

        - name: Git config for rhdh/users repo
          ansible.builtin.shell: |
              git config credential.helper store
              git config user.name "Administrator"
              git config user.email "root@opentlc.com"
          args:
            chdir: "{{ "{{" }} rhdh_users_repo_local_path {{ "}}" }}"

        - name: Commit and push rhdh_users file
          ansible.builtin.shell:
            cmd: |
              git remote set-url origin {{ "{{" }} rhdh_users_repo {{ "}}" }}
              git add {{ "{{" }} rhdh_users_filename {{ "}}" }}
              git commit -m "feat: Add {{ "{{" }} cluster {{ "}}" }} users" || true
              git push -u origin main || git push -u origin master || true
              rm -rf {{ "{{" }} rhdh_users_repo_local_path {{ "}}" }}
          args:
            chdir: "{{ "{{" }} rhdh_users_repo_local_path {{ "}}" }}"
          ignore_errors: true

        - name: Remove branch protection
          ansible.builtin.uri:
            url: '{{ "{{" }} gitlab_api {{ "}}" }}/application/settings'
            method: PUT
            body_format: form-urlencoded
            body:
              default_branch_protection: 0
            headers:
              PRIVATE-TOKEN: '{{ "{{" }} root_token {{ "}}" }}'
            validate_certs: false
            status_code: 200

        - name: Delete old OpenCodeQuest templates
          ansible.builtin.uri:
            url: '{{ "{{" }} gitlab_api {{ "}}" }}/projects/rhdh%2Fopencodequest-templates'
            method: DELETE
            body_format: form-urlencoded
            body:
              permanently_remove: true
            headers:
              PRIVATE-TOKEN: '{{ "{{" }} root_token {{ "}}" }}'
            validate_certs: false
            status_code: [ 202 , 404 ]

        - name: Clone GitHub OpenCodeQuest source repo
          ansible.builtin.git:
            repo: "{{ "{{" }} gh_source_repo {{ "}}" }}"
            dest: "{{ "{{" }} repo_local_path {{ "}}" }}"
            clone: yes
            update: yes

        - name: Update domain_name with GitLab FQDN in Location
          ansible.builtin.replace:
            path: "{{ "{{" }} item {{ "}}" }}"
            regexp: 'github.com/rh-opencodequest/rhdh-templates/blob/main/'
            replace: '{{ "{{" }} gitlab_hostname {{ "}}" }}/rhdh/opencodequest-templates/-/blob/master/'
            backup: no
          loop:
            - "{{ "{{" }} repo_local_path {{ "}}" }}/scaffolder-templates/opencodequest-templates.yaml"

        - name: Update domain_name with GitLab FQDN in templates
          ansible.builtin.replace:
            path: "{{ "{{" }} item {{ "}}" }}"
            regexp: 'apps.cluster-rw97m.sandbox266.opentlc.com'
            replace: '{{ "{{" }} domain_name {{ "}}" }}'
            backup: no
          loop:
            - "{{ "{{" }} repo_local_path {{ "}}" }}/scaffolder-templates/fight-ui/template.yaml"
            - "{{ "{{" }} repo_local_path {{ "}}" }}/scaffolder-templates/quarkus-ai/template.yaml"
            - "{{ "{{" }} repo_local_path {{ "}}" }}/scaffolder-templates/quarkus-postgresql/template.yaml"
            - "{{ "{{" }} repo_local_path {{ "}}" }}/scaffolder-templates/quarkus-with-spring-postgresql/template.yaml"

        - name: Update quay hostname
          ansible.builtin.replace:
            path: "{{ "{{" }} item {{ "}}" }}"
            regexp: 'quay-.*'
            replace: 'quay-{{ "{{" }} ocp_uid {{ "}}" }}.{{ "{{" }} domain_name {{ "}}" }}'
            backup: no
          loop:
            - "{{ "{{" }} repo_local_path {{ "}}" }}/scaffolder-templates/fight-ui/template.yaml"
            - "{{ "{{" }} repo_local_path {{ "}}" }}/scaffolder-templates/quarkus-ai/template.yaml"
            - "{{ "{{" }} repo_local_path {{ "}}" }}/scaffolder-templates/quarkus-postgresql/template.yaml"
            - "{{ "{{" }} repo_local_path {{ "}}" }}/scaffolder-templates/quarkus-with-spring-postgresql/template.yaml"

        - name: git config
          ansible.builtin.shell: |
              rm -rf .git
              git init --initial-branch=master
              git config credential.helper store
              git config user.name "Administrator"
              git config user.email "root@opentlc.com"
              git config user.password {{ "{{" }} root_token {{ "}}" }}
          args:
            chdir: "{{ "{{" }} repo_local_path {{ "}}" }}"

        - name: git push
          ansible.builtin.shell:
            cmd: | 
              git remote add origin {{ "{{" }} gl_dest_repo {{ "}}" }}
              git add .
              git commit -m "Initial commit"
              git push -u origin master
              rm -rf {{ "{{" }} repo_local_path {{ "}}" }}
          args:
            chdir: "{{ "{{" }} repo_local_path {{ "}}" }}"

        - name: Set opencodequest-templates repository to public
          ansible.builtin.uri:
            url: '{{ "{{" }} gitlab_api {{ "}}" }}/projects/rhdh%2Fopencodequest-templates'
            method: PUT
            body_format: form-urlencoded
            body:
              visibility: public
            headers:
              PRIVATE-TOKEN: '{{ "{{" }} root_token {{ "}}" }}'
            validate_certs: false
            status_code: 200
          ignore_errors: true

        # - name: Clone janus-idp-gitops repo
        #   ansible.builtin.git:
        #     repo: "{{ "{{" }} rhdh_gitops_repo {{ "}}" }}"
        #     dest: "{{ "{{" }} rhdh_gitops_repo_local_path {{ "}}" }}"
        #     clone: yes
        #     update: yes

        # - name: Load the value file
        #   set_fact:
        #     yaml_data: "{{ "{{" }} lookup('file', '{{ "{{" }} rhdh_gitops_repo_local_path {{ "}}" }}/charts/backstage/backstage-rhtap-values.yaml') | from_yaml {{ "}}" }}"

        # - name: Define new catalog locations
        #   set_fact:
        #     new_catalog_locations:
        #       upstream:
        #         backstage:
        #           appConfig:
        #             catalog:
        #               locations:
        #                 - rules:
        #                   - allow:
        #                     - Template
        #                   target: https://{{ "{{" }} gitlab_hostname {{ "}}" }}/rhdh/opencodequest-templates/-/blob/master/scaffolder-templates/opencodequest-templates.yaml
        #                   type: url

        # - name: Merge new catalog locations
        #   set_fact:
        #     updated_yaml: >-
        #       {{ "{{" }}
        #         yaml_data | combine(
        #           new_catalog_locations,
        #           recursive=True,
        #           list_merge='append'
        #         )
        #       {{ "}}" }}

        # - name: Save the updated YAML to disk
        #   ansible.builtin.copy:
        #     dest: "{{ "{{" }} rhdh_gitops_repo_local_path {{ "}}" }}/charts/backstage/backstage-rhtap-values.yaml"
        #     content: "{{ "{{" }} updated_yaml | to_nice_yaml {{ "}}" }}"

        # - name: git push
        #   ansible.builtin.shell:
        #     cmd: | 
        #       cat "{{ "{{" }} rhdh_gitops_repo_local_path {{ "}}" }}/charts/backstage/backstage-rhtap-values.yaml"
        #       git remote add origin {{ "{{" }} rhdh_gitops_repo {{ "}}" }}
        #       git add .
        #       git commit -m "feat: Add opencodequest templates"
        #       git push -u origin main
        #       rm -rf {{ "{{" }} rhdh_gitops_repo_local_path {{ "}}" }}
        #   args:
        #     chdir: "{{ "{{" }} rhdh_gitops_repo_local_path {{ "}}" }}"